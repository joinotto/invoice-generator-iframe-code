<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="Professional invoice generator with PDF export">
  
  <!-- Performance optimizations -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="https://unpkg.com/react@18/umd/react.production.min.js" as="script">
  <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" as="script">
  <link rel="preload" href="https://unpkg.com/@babel/standalone/babel.min.js" as="script">
  <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
  <link rel="preload" href="https://unpkg.com/html2pdf.js@0.10.3/dist/html2pdf.bundle.js" as="script">
  
  <title>Invoice Generator - Preview</title>
  
  <!-- Core dependencies for the embeddable component -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- App dependencies -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/html2pdf.js@0.10.3/dist/html2pdf.bundle.js"></script>
  
  <style>
    /* Optimized CSS with better performance */
    body {
      margin: 0;
      background-color: #f0f2f5;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      /* Performance optimizations */
      text-rendering: optimizeSpeed;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Optimized scrollbar styles */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Optimized animations */
    @keyframes invoice-embed-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .invoice-embed-spinner-animation { 
      animation: invoice-embed-spin 1s linear infinite;
      will-change: transform; /* Performance optimization */
    }
    
    /* Optimized image loading */
    img {
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    
    /* Performance optimizations for transitions */
    * {
      box-sizing: border-box;
    }
    
    /* Optimize paint and layout operations */
    .transition-colors {
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out;
      will-change: color, background-color, border-color;
    }
  </style>
</head>
<body>
  <div id="invoice-generator-embed-container" style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; border-radius: 8px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; margin: 0 auto; max-width: 1280px;">
    <div id="invoice-generator-embed-root"></div>
    <style>
      #invoice-generator-embed-container * { box-sizing: border-box; }
      #invoice-generator-embed-container ::-webkit-scrollbar { width: 8px; height: 8px; }
      #invoice-generator-embed-container ::-webkit-scrollbar-track { background: #f1f1f1; }
      #invoice-generator-embed-container ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
      #invoice-generator-embed-container ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
      @keyframes invoice-embed-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .invoice-embed-spinner-animation { 
        animation: invoice-embed-spin 1s linear infinite;
        will-change: transform;
      }
    </style>
  </div>

  <!-- React App Script: All JS/JSX, nothing else inside this block -->
  <script type="text/babel">
    // --- IMPORTS/HOOKS ---
    const { useState, useRef, useCallback, useMemo, StrictMode, memo } = React;

    // --- Utility: Generate unique item IDs ---
    const generateItemId = () => Date.now().toString(36) + Math.random().toString(36).substring(2, 7);

    // --- Invoice item initial structure ---
    const INITIAL_ITEM = { id: generateItemId(), description: '', rate: 0, quantity: 1 };

    // --- Currency list (shortened for brevity; add more as you need) ---
    const CURRENCIES = [
      { code: 'USD', name: 'United States Dollar' },
      { code: 'EUR', name: 'Euro' },
      { code: 'JPY', name: 'Japanese Yen' },
      { code: 'GBP', name: 'British Pound Sterling' },
      { code: 'AUD', name: 'Australian Dollar' },
      { code: 'CAD', name: 'Canadian Dollar' },
      { code: 'CHF', name: 'Swiss Franc' },
      { code: 'CNY', name: 'Chinese Yuan' },
      { code: 'INR', name: 'Indian Rupee' },
      // ... You can add more currencies if needed
    ];

    // --- Style helpers ---
    const INPUT_BASE_CLASS = "block w-full px-3 py-2 text-sm text-gray-800 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500";
    const LABEL_BASE_CLASS = "block text-xs font-medium text-gray-600 mb-1";
    const REQUIRED_FIELDS_CONFIG = [
      { key: 'fromName', label: 'From Name' },
      { key: 'fromEmail', label: 'From Email' },
      { key: 'fromAddress1', label: 'From Address' },
      { key: 'toName', label: 'To Name' },
      { key: 'toEmail', label: 'To Email' },
      { key: 'toAddress1', label: 'To Address' },
    ];

    // --- Dates ---
    const todayConst = new Date();
    const thirtyDaysFromNowConst = new Date();
    thirtyDaysFromNowConst.setDate(todayConst.getDate() + 30);
    const DEFAULT_INVOICE_DATE = todayConst.toISOString().split('T')[0];
    const DEFAULT_DUE_DATE = thirtyDaysFromNowConst.toISOString().split('T')[0];

    // --- Currency formatting (memoized) ---
    const formatCurrency = (() => {
      const symbols = {
        'USD': '$', 'EUR': '‚Ç¨', 'GBP': '¬£', 'JPY': '¬•', 'CAD': 'C$',
        'AUD': 'A$', 'CHF': 'CHF', 'CNY': '¬•', 'INR': '‚Çπ'
      };
      
      return (amount, currency = 'USD') => {
        const symbol = symbols[currency] || currency;
        if (typeof amount !== 'number' || isNaN(amount)) return `${symbol}0.00`;
        return `${symbol}${amount.toFixed(2)}`;
      };
    })();

    const formatDate = (dateString) => {
      if (!dateString) return '';
      try {
        const dateParts = dateString.split('-');
        if (dateParts.length === 3) {
          const year = parseInt(dateParts[0], 10);
          const month = parseInt(dateParts[1], 10) - 1;
          const day = parseInt(dateParts[2], 10);
          const date = new Date(Date.UTC(year, month, day));
          if (isNaN(date.getTime())) return 'Invalid Date';
          return date.toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC',
          });
        }
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'Invalid Date';
        return date.toLocaleDateString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric',
        });
      } catch (error) { return 'Invalid Date'; }
    };

    // --- Spinner Component (memoized) ---
    const Spinner = memo(() => (
      <div className="invoice-embed-spinner-animation h-5 w-5 border-2 border-gray-300 border-t-indigo-600 rounded-full" role="status">
        <span className="sr-only">Loading...</span>
      </div>
    ));

    // --- IconButton Component (memoized) ---
    const IconButton = memo(({ onClick, children, className = '', ariaLabel, disabled = false }) => (
      <button
        type="button"
        onClick={onClick}
        aria-label={ariaLabel}
        disabled={disabled}
        className={`p-1 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1
          ${disabled ? 'text-gray-300 cursor-not-allowed' : 'text-gray-400 hover:text-red-500 focus:ring-red-400'}
          ${className}`}
      >
        {children}
      </button>
    ));

    // --- InvoicePreview (memoized with useMemo for calculations) ---
    const InvoicePreview = memo(({ state, isForPdf = false }) => {
      const baseText = isForPdf ? 'text-xs' : 'text-base';
      const sectionTitleText = isForPdf ? 'text-xs' : 'text-lg';

      // Memoize calculations to prevent recalculation on every render
      const { subtotal, total, balanceDue } = useMemo(() => {
        const subtotal = state.items.reduce((acc, item) => acc + (Number(item.rate) || 0) * (Number(item.quantity) || 0), 0);
        const total = subtotal;
        const balanceDue = total;
        return { subtotal, total, balanceDue };
      }, [state.items]);

      return (
        <div className="bg-white p-8 md:p-10 lg:p-12">
          <div className="flex flex-row items-start justify-between mb-8 gap-4">
            <div>
              <h1 className="text-5xl md:text-6xl font-bold text-gray-900 mb-2">Invoice</h1>
              <div className="space-y-1 mt-2">
                <div className="text-base text-gray-700 flex gap-2">
                  <span className="font-semibold min-w-[96px]">Invoice #</span>
                  <span>{state.invoiceNumber || '‚Äî'}</span>
                </div>
                <div className="text-base text-gray-700 flex gap-2">
                  <span className="font-semibold min-w-[96px]">Date</span>
                  <span>{formatDate(state.invoiceDate)}</span>
                </div>
                <div className="text-base text-gray-700 flex gap-2">
                  <span className="font-semibold min-w-[96px]">Due Date</span>
                  <span>{formatDate(state.dueDate)}</span>
                </div>
              </div>
            </div>
            {state.logoUrl && (
              <div className="flex-shrink-0 flex items-center h-20">
                <img
                  src={state.logoUrl}
                  alt="Company Logo"
                  className="max-h-20 object-contain"
                  style={{ maxWidth: '180px' }}
                />
              </div>
            )}
          </div>

          <div className={`grid grid-cols-1 md:grid-cols-2 gap-x-8 min-w-0 ${isForPdf ? 'mb-1' : 'mb-10'} ${baseText}`}>
            <div className="min-w-0">
              <h3 className={`${sectionTitleText} font-semibold uppercase tracking-wider text-gray-600 ${isForPdf ? 'mb-0.5 text-[0.6rem]' : 'mb-3 text-sm'}`}>From</h3>
              <div className={`${isForPdf ? 'space-y-0 leading-tight' : 'space-y-1'} text-gray-900`}>
                <p className="font-medium">{state.fromName || 'Your Company Name'}</p>
                <p className="break-all whitespace-pre-line">{state.fromEmail || 'your.email@example.com'}</p>
                <p>{state.fromAddress1 || '123 Main St, City, State, Zip'}</p>
                {state.fromAddress2 && <p>{state.fromAddress2}</p>}
                {state.showAdditionalFromDetails && state.fromBusinessNumber && (
                  <p>Business #: {state.fromBusinessNumber}</p>
                )}
              </div>
            </div>
            <div className="min-w-0 mt-6 md:mt-0">
              <h3 className={`${sectionTitleText} font-semibold uppercase tracking-wider text-gray-600 ${isForPdf ? 'mb-0.5 text-[0.6rem]' : 'mb-3 text-sm'}`}>To</h3>
              <div className={`${isForPdf ? 'space-y-0 leading-tight' : 'space-y-1'} text-gray-900`}>
                <p className="font-medium">{state.toName || 'Client Company Name'}</p>
                <p className="break-all whitespace-pre-line">{state.toEmail || 'client.email@example.com'}</p>
                <p>{state.toAddress1 || '456 Client Ave, City, State, Zip'}</p>
                {state.toAddress2 && <p>{state.toAddress2}</p>}
                {state.toFax && <p>Fax: {state.toFax}</p>}
              </div>
            </div>
          </div>

          <div className="mb-10">
            <table className="w-full">
              <thead>
                <tr className="border-b-2 border-gray-200">
                  <th className="text-left py-0.5 pr-2 text-xs font-semibold uppercase tracking-wider text-gray-600">Item</th>
                  <th className="text-center py-0.5 px-1 text-xs font-semibold uppercase tracking-wider text-gray-600">Qty</th>
                  <th className="text-right py-0.5 px-1 text-xs font-semibold uppercase tracking-wider text-gray-600">Price</th>
                  <th className="text-right py-0.5 pl-1 text-xs font-semibold uppercase tracking-wider text-gray-600">Amount</th>
                </tr>
              </thead>
              <tbody>
                {state.items.map((item) => (
                  <tr key={item.id} className="border-b border-gray-100 last:border-b-0 text-base">
                    <td className="py-0.5 pr-2 text-gray-900">{item.description || 'Service or Product Description'}</td>
                    <td className="py-0.5 px-1 text-center text-gray-900">{item.quantity}</td>
                    <td className="py-0.5 px-1 text-right text-gray-900">{formatCurrency(Number(item.rate), state.selectedCurrency)}</td>
                    <td className="py-0.5 pl-1 text-right font-medium text-gray-900">{formatCurrency((Number(item.rate) || 0) * (Number(item.quantity) || 0), state.selectedCurrency)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          <div className="flex justify-end mb-10">
            <div className="w-full sm:w-64 space-y-0.5 text-base">
              <div className="flex justify-between">
                <span className="text-gray-600">Subtotal</span>
                <span className="text-gray-900 font-medium">{formatCurrency(subtotal, state.selectedCurrency)}</span>
              </div>
              <div className="flex justify-between text-lg font-bold border-t border-gray-200 pt-0.5 mt-0.5">
                <span className="text-gray-900">Total</span>
                <span className="text-gray-900">{formatCurrency(total, state.selectedCurrency)}</span>
              </div>
              <div className="flex justify-between text-2xl font-bold text-indigo-600">
                <span>Amount Due</span>
                <span>{formatCurrency(balanceDue, state.selectedCurrency)}</span>
              </div>
            </div>
          </div>

          {state.memo && (
            <div className="mb-10">
              <h4 className="text-xs font-semibold uppercase tracking-wider text-gray-600 mb-2">Notes</h4>
              <p className="text-base text-gray-900 whitespace-pre-wrap">{state.memo}</p>
            </div>
          )}

          <div style={{ breakInside: 'avoid', pageBreakInside: 'avoid', WebkitBreakInside: 'avoid', MozBreakInside: 'avoid' }}>
            {state.signature && (
              <div className="mt-6">
                <h4 className="text-xs font-semibold uppercase tracking-wider text-gray-600 mb-2">Signature</h4>
                {(state.signature.startsWith('data:image') || state.signature.startsWith('blob:')) ? (
                  <img src={state.signature} alt="Signature Preview" className="max-h-20 border-b-2 border-gray-300 pb-1 object-contain" />
                ) : (
                  <p className="font-serif text-3xl border-b-2 border-gray-300 pb-1 inline-block break-all text-gray-900">
                    {state.signature}
                  </p>
                )}
              </div>
            )}

            <div className="text-center mt-4 pt-2 border-t border-gray-200">
              <p className="text-xs text-gray-500">
                Powered by <span className="font-medium text-indigo-600">otto</span>
              </p>
            </div>
          </div>
        </div>
      );
    });

    // --- Main App Component ---
    const App = () => {
      const [state, setState] = useState({
        invoiceNumber: 'INV0001',
        invoiceDate: DEFAULT_INVOICE_DATE,
        dueDate: DEFAULT_DUE_DATE,
        logoUrl: null,
        fromName: '',
        fromEmail: '',
        fromAddress1: '',
        fromAddress2: '',
        fromBusinessNumber: '',
        toName: '',
        toEmail: '',
        toAddress1: '',
        toAddress2: '',
        toFax: '',
        items: [{ ...INITIAL_ITEM, id: generateItemId() }],
        memo: '',
        signature: null,
        selectedCurrency: 'USD',
        showAdditionalFromDetails: false,
        activeTab: 'invoice',
        errors: {},
        isGeneratingPdf: false,
        showSignatureTypeInput: false,
        typedSignatureInput: '',
      });

      const logoInputRef = useRef(null);
      const signatureUploadInputRef = useRef(null);
      const mainPreviewRef = useRef(null);

      // Memoize calculations to prevent recalculation on every render
      const { subtotal, total, balanceDue } = useMemo(() => {
        const subtotal = state.items.reduce((acc, item) => acc + (Number(item.rate) || 0) * (Number(item.quantity) || 0), 0);
        const total = subtotal;
        const balanceDue = total;
        return { subtotal, total, balanceDue };
      }, [state.items]);

      // Memoize field configurations to prevent recreation
      const fromFields = useMemo(() => [
        { name: 'fromName', label: 'Name *', placeholder: 'Your Company Name' },
        { name: 'fromEmail', label: 'Email *', placeholder: 'your.email@example.com', type: 'email' },
        { name: 'fromAddress1', label: 'Address Line 1 *', placeholder: '123 Main St' },
        { name: 'fromAddress2', label: 'Address Line 2', placeholder: 'Suite, Apt, etc.' },
      ], []);

      const toFields = useMemo(() => [
        { name: 'toName', label: 'Name *', placeholder: 'Client Company Name' },
        { name: 'toEmail', label: 'Email *', placeholder: 'client.email@example.com', type: 'email' },
        { name: 'toAddress1', label: 'Address Line 1 *', placeholder: '456 Client Ave' },
        { name: 'toAddress2', label: 'Address Line 2', placeholder: 'Suite, Apt, etc.' },
        { name: 'toFax', label: 'Fax (Optional)', placeholder: '(123) 456-7890' },
      ], []);

      const handleInputChange = useCallback((e) => {
        const { name, value } = e.target;
        setState(prevState => ({
          ...prevState,
          [name]: value,
          errors: { ...prevState.errors, [name]: undefined }
        }));
      }, []);

      const handleFileUpload = useCallback((e, field) => {
        const file = e.target.files?.[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            setState(prevState => ({ ...prevState, [field]: event.target?.result }));
          };
          reader.readAsDataURL(file);
        }
        if(e.target) e.target.value = ''; // Reset file input
      }, []);

      const handleItemChange = useCallback((index, field, value) => {
        setState(prevState => {
          const newItems = prevState.items.map((item, i) => {
            if (i === index) {
              let processedValue = value;
              if (field === 'rate' || field === 'quantity') {
                processedValue = parseFloat(value.toString()) || 0;
                if (field === 'quantity' && processedValue < 0) processedValue = 0;
              }
              return { ...item, [field]: processedValue };
            }
            return item;
          });
          return { ...prevState, items: newItems };
        });
      }, []);

      const addItem = useCallback(() => {
        setState(prevState => ({
          ...prevState,
          items: [...prevState.items, { ...INITIAL_ITEM, id: generateItemId() }]
        }));
      }, []);

      const removeItem = useCallback((indexToRemove) => {
        setState(prevState => {
          if (prevState.items.length <= 1) {
            const item = prevState.items[0];
            if (item.description === '' && Number(item.rate) === 0 && Number(item.quantity) === 1) {
              return { ...prevState, items: [{ ...INITIAL_ITEM, id: generateItemId() }] };
            } else {
              return prevState;
            }
          }
          const newItems = prevState.items.filter((_, i) => i !== indexToRemove);
          return { ...prevState, items: newItems };
        });
      }, []);

      const validateForm = useCallback((formState) => {
        const errors = {};
        REQUIRED_FIELDS_CONFIG.forEach(fieldInfo => {
          const value = formState[fieldInfo.key];
          if (!value?.toString().trim()) {
            errors[fieldInfo.key] = `${fieldInfo.label} is required.`;
          }
        });

        if (formState.fromEmail && !/\S+@\S+\.\S+/.test(formState.fromEmail)) {
          errors.fromEmail = 'Invalid email format.';
        }
        if (formState.toEmail && !/\S+@\S+\.\S+/.test(formState.toEmail)) {
          errors.toEmail = 'Invalid email format.';
        }
        return errors;
      }, []);

      const renderField = useCallback((fieldName, label, placeholder, type = 'text', extraInputProps = {}) => (
        <div key={fieldName}>
          <label htmlFor={fieldName} className={LABEL_BASE_CLASS}>{label}</label>
          <input
            type={type}
            id={fieldName}
            name={fieldName}
            value={state[fieldName] || ''}
            onChange={handleInputChange}
            placeholder={placeholder}
            className={INPUT_BASE_CLASS}
            aria-required={REQUIRED_FIELDS_CONFIG.some(f => f.key === fieldName)}
            {...extraInputProps}
          />
          {state.errors[fieldName] && <p className="text-red-500 text-xs mt-1" role="alert">{state.errors[fieldName]}</p>}
        </div>
      ), [state, handleInputChange]);

      // Memoize tab configuration to prevent recreation
      const tabConfig = useMemo(() => [
        {key: 'invoice', label: 'Invoice Editor'},
        {key: 'preview', label: 'Live Preview'}
      ], []);

      // Optimized PDF generation with better error handling and performance
      const optimizedPdfGeneration = useCallback(async () => {
        const validationErrors = validateForm(state);
        if (Object.keys(validationErrors).length > 0) {
            setState(prev => ({ ...prev, errors: validationErrors, activeTab: 'invoice' }));
            alert("Please fill in all required fields marked with * before downloading the PDF.");
            return;
        }

        setState(prev => ({ ...prev, activeTab: 'preview', isGeneratingPdf: true }));

        // Use requestAnimationFrame for better performance
        requestAnimationFrame(async () => {
            try {
                const html2pdf = window.html2pdf;
                const element = mainPreviewRef.current;
                
                if (!html2pdf) throw new Error("PDF generation library (html2pdf.js) is not available.");
                if (!element) throw new Error("Preview content is not ready for PDF generation.");
                if (element.offsetWidth === 0 || element.offsetHeight === 0) throw new Error("Preview content has zero dimensions. PDF cannot be generated.");
                
                // Optimized PDF options for better performance
                const opt = {
                    margin: [0.4, 0.4, 0.4, 0.4],
                    filename: `${state.invoiceNumber || 'invoice'}.pdf`,
                    image: { type: 'jpeg', quality: 0.95 }, // Slightly reduced quality for better performance
                    html2canvas: {
                        scale: 1.5, // Reduced scale for better performance
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: true,
                        logging: false, // Disable logging for better performance
                        removeContainer: true, // Clean up after generation
                    },
                    jsPDF: {
                        unit: 'in',
                        format: 'letter',
                        orientation: 'portrait',
                        compress: true,
                    }
                };
                
                // Scroll to top before generation
                window.scrollTo(0, 0);
                
                // Generate PDF with timeout protection
                const pdfPromise = html2pdf().set(opt).from(element).save();
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('PDF generation timed out')), 30000)
                );
                
                await Promise.race([pdfPromise, timeoutPromise]);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert(`Could not generate PDF. Error: ${error instanceof Error ? error.message : String(error)}`);
            } finally {
                setState(prev => ({ ...prev, isGeneratingPdf: false }));
            }
        });
      }, [state, validateForm]);

      return (
        <div className={state.activeTab === "invoice" ? "min-h-screen bg-gray-100" : "bg-gray-100"}>
          {state.isGeneratingPdf && (
            <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="loading-message">
              <div className="bg-white p-6 rounded-lg shadow-xl text-center flex items-center space-x-3">
                <Spinner />
                <p id="loading-message" className="text-sm font-medium text-gray-700">Generating PDF, please wait...</p>
              </div>
            </div>
          )}

          <header className="bg-white border-b border-gray-200 sticky top-0 z-40">
            <div className="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
              <div className="flex justify-between items-center py-4">
                <div className="flex items-center">
                  <span className="text-2xl font-bold text-indigo-600">otto</span>
                </div>
                <nav className="flex space-x-1" aria-label="Main navigation">
                  {tabConfig.map(tab => (
                    <button
                      key={tab.key}
                      type="button"
                      role="tab"
                      aria-selected={state.activeTab === tab.key}
                      onClick={() => setState(s => ({ ...s, activeTab: tab.key }))}
                      className={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
                        state.activeTab === tab.key
                          ? 'bg-indigo-100 text-indigo-700'
                          : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </nav>
              </div>
            </div>
          </header>

          <main className="max-w-screen-xl mx-auto p-4 sm:p-6 lg:p-8">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
              {state.activeTab === 'invoice' ? (
                <div className="lg:col-span-2 space-y-6" role="tabpanel" aria-labelledby="invoice-tab-button">
                  <input type="file" ref={logoInputRef} onChange={(e) => handleFileUpload(e, 'logoUrl')} accept="image/*" className="hidden" aria-label="Upload company logo" />
                  <input type="file" ref={signatureUploadInputRef} onChange={(e) => handleFileUpload(e, 'signature')} accept="image/*" className="hidden" aria-label="Upload signature image"/>

                  <section className="bg-white rounded-lg shadow-md p-6" aria-labelledby="invoice-details-heading">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                      <div className="space-y-4">
                        <h2 id="invoice-details-heading" className="text-lg font-semibold text-gray-800 mb-0">Invoice Details</h2>
                        {renderField('invoiceNumber', 'Invoice Number', 'INV0001')}
                        {renderField('invoiceDate', 'Invoice Date', '', 'date', { onFocus: e => e.target.showPicker && e.target.showPicker() })}
                        {renderField('dueDate', 'Due Date', '', 'date', { onFocus: e => e.target.showPicker && e.target.showPicker() })}
                      </div>
                      <div className="space-y-4">
                        <h3 className="text-lg font-semibold text-gray-800">Company Logo</h3>
                          {state.logoUrl ? (
                            <div className="border border-gray-200 rounded-md p-4 text-center">
                              <img 
                                src={state.logoUrl} 
                                alt="Company Logo Preview" 
                                className="mx-auto max-h-20 object-contain mb-2" 
                                loading="lazy"
                                onError={(e) => {
                                  e.target.style.display = 'none';
                                  setState(s => ({ ...s, logoUrl: null }));
                                }}
                              />
                              <button type="button" onClick={() => setState(s => ({ ...s, logoUrl: null }))} className="text-xs text-red-500 hover:text-red-700">Remove Logo</button>
                            </div>
                          ) : (
                            <div className="border-2 border-dashed border-gray-300 rounded-md p-6 text-center">
                              <button type="button" onClick={() => logoInputRef.current?.click()} className="w-full py-3 px-4 text-sm font-medium bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-md flex flex-col items-center justify-center gap-2 border border-gray-200 hover:border-gray-300 transition-colors">
                                <span>üì§</span>
                                <span>Upload Company Logo</span>
                                <span className="text-xs text-gray-400">PNG, JPG up to 10MB</span>
                              </button>
                            </div>
                          )}
                      </div>
                    </div>
                  </section>

                  <section className="bg-white rounded-lg shadow-md p-6" aria-labelledby="billing-details-heading">
                    <h2 id="billing-details-heading" className="sr-only">Billing Details</h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                        <div className="space-y-4">
                            <h3 className="text-lg font-semibold text-gray-800">From</h3>
                            {fromFields.map(f => renderField(f.name, f.label, f.placeholder, f.type))}
                        </div>
                        <div className="space-y-4">
                            <h3 className="text-lg font-semibold text-gray-800">Bill To</h3>
                            {toFields.map(f => renderField(f.name, f.label, f.placeholder, f.type))}
                        </div>
                    </div>
                  </section>

                  <section className="bg-white rounded-lg shadow-md p-6" aria-labelledby="items-heading">
                    <h2 id="items-heading" className="text-lg font-semibold text-gray-800 mb-4">Items</h2>
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[600px]" aria-label="Invoice items">
                            <thead>
                                <tr className="border-b border-gray-200">
                                    <th scope="col" className="text-left py-2 pr-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-auto">Description</th>
                                    <th scope="col" className="text-center py-2 px-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-28">Rate</th>
                                    <th scope="col" className="text-center py-2 px-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-20">Qty</th>
                                    <th scope="col" className="text-right py-2 px-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-32">Amount</th>
                                    <th scope="col" className="text-right py-2 pl-2 text-xs font-medium text-gray-500 uppercase tracking-wider w-10"><span className="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {state.items.map((item, index) => (
                                    <tr key={item.id} className="border-b border-gray-100 last:border-b-0">
                                        <td className="py-2 pr-2">
                                            <input type="text" placeholder="Item Description" value={item.description} onChange={(e) => handleItemChange(index, 'description', e.target.value)} className={`${INPUT_BASE_CLASS} py-1.5`} aria-label={`Item ${index + 1} description`} />
                                        </td>
                                        <td className="py-2 px-2">
                                            <input type="number" placeholder="0.00" value={item.rate} onChange={(e) => handleItemChange(index, 'rate', e.target.value)} step="0.01" className={`${INPUT_BASE_CLASS} text-right py-1.5`} aria-label={`Item ${index + 1} rate`} />
                                        </td>
                                        <td className="py-2 px-2">
                                            <input type="number" placeholder="1" value={item.quantity} onChange={(e) => handleItemChange(index, 'quantity', e.target.value)} min="0" className={`${INPUT_BASE_CLASS} text-center py-1.5`} aria-label={`Item ${index + 1} quantity`} />
                                        </td>
                                        <td className="py-2 px-2 text-right">
                                            <span className="text-sm text-gray-700">{formatCurrency((Number(item.rate) || 0) * (Number(item.quantity) || 0), state.selectedCurrency)}</span>
                                        </td>
                                        <td className="py-2 pl-2 text-right align-middle">
                                            {(state.items.length > 1 || (item.description === '' && Number(item.rate) === 0 && Number(item.quantity) === 1)) && (
                                              <IconButton onClick={() => removeItem(index)} ariaLabel={`Remove item ${index + 1}`}
                                                disabled={state.items.length <=1 && !(item.description === '' && Number(item.rate) === 0 && Number(item.quantity) === 1) }>
                                                ‚úï
                                              </IconButton>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="flex items-center justify-between mt-4">
                        <button type="button" onClick={addItem} className="inline-flex items-center gap-1.5 text-sm font-medium text-indigo-600 hover:text-indigo-800 py-2 px-3 rounded-md hover:bg-indigo-50 transition-colors">
                            + Add Item
                        </button>
                        <div className="w-64" aria-live="polite">
                            <div className="space-y-1 text-sm">
                                <div className="flex justify-between"><span className="text-gray-600">Subtotal</span><span className="text-gray-800 font-medium">{formatCurrency(subtotal, state.selectedCurrency)}</span></div>
                                <div className="flex justify-between font-semibold text-base"><span className="text-gray-700">Total</span><span className="text-gray-900">{formatCurrency(total, state.selectedCurrency)}</span></div>
                                <div className="flex justify-between font-bold text-indigo-600 text-lg border-t border-gray-200 pt-1 mt-1"><span>Amount Due</span><span>{formatCurrency(balanceDue, state.selectedCurrency)}</span></div>
                            </div>
                        </div>
                    </div>
                  </section>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <section className="bg-white rounded-lg shadow-md p-6" aria-labelledby="additional-details-heading">
                        <h2 id="additional-details-heading" className="text-lg font-semibold text-gray-800 mb-3">Additional Details</h2>
                        <div>
                            <label htmlFor="memo" className={LABEL_BASE_CLASS}>Memo / Notes</label>
                            <textarea id="memo" name="memo" value={state.memo} onChange={handleInputChange} placeholder="Add any additional notes or payment terms..." rows={3} className={`${INPUT_BASE_CLASS} min-h-[80px]`}></textarea>
                        </div>
                    </section>
                    <section className="bg-white rounded-lg shadow-md p-6" aria-labelledby="signature-heading">
                        <h2 id="signature-heading" className="text-lg font-semibold text-gray-800 mb-3 text-center md:text-left">Signature</h2>
                          {state.signature ? (
                            <div className="border border-gray-200 rounded-md p-4 text-center">
                              {(state.signature.startsWith('data:image') || state.signature.startsWith('blob:')) ? (
                                <img 
                                  src={state.signature} 
                                  alt="Signature preview" 
                                  className="mx-auto max-h-20 object-contain mb-2" 
                                  loading="lazy"
                                  onError={(e) => {
                                    e.target.style.display = 'none';
                                    setState(s => ({ ...s, signature: null }));
                                  }}
                                />
                              ) : (
                                <p className="font-serif text-2xl break-all text-gray-700 mb-2">{state.signature}</p>
                              )}
                              <button type="button" onClick={() => setState(s => ({ ...s, signature: null, showSignatureTypeInput: false, typedSignatureInput: '' }))} className="text-xs text-red-500 hover:text-red-700">Clear Signature</button>
                            </div>
                          ) : (
                            <div className="border-2 border-dashed border-gray-300 rounded-md p-4 text-center">
                              {state.showSignatureTypeInput ? (
                                <div className="space-y-3">
                                  <label htmlFor="typedSignatureInput" className="sr-only">Type your signature</label>
                                  <input id="typedSignatureInput" type="text" placeholder="Type your name" value={state.typedSignatureInput} onChange={(e) => setState(s => ({ ...s, typedSignatureInput: e.target.value }))} className={`${INPUT_BASE_CLASS} text-center`} />
                                  <div className="flex gap-2 justify-center">
                                    <button type="button" onClick={() => {
                                      const trimmedSignature = state.typedSignatureInput.trim();
                                      setState(s => ({ ...s, signature: trimmedSignature || null, showSignatureTypeInput: false, typedSignatureInput: '' }));
                                    }} className="px-4 py-1.5 text-sm font-medium bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors">Save Signature</button>
                                    <button type="button" onClick={() => setState(s => ({ ...s, showSignatureTypeInput: false, typedSignatureInput: '' }))} className="px-4 py-1.5 text-sm font-medium bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md transition-colors">Cancel</button>
                                  </div>
                                </div>
                              ) : (
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                  <button type="button" onClick={() => signatureUploadInputRef.current?.click()} className="py-3 px-3 text-sm font-medium bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-md flex flex-col items-center justify-center gap-1 border border-gray-200 hover:border-gray-300 transition-colors h-16">
                                    <span>üì§</span><span className="text-xs">Upload Image</span>
                                  </button>
                                  <button type="button" onClick={() => setState(s => ({ ...s, showSignatureTypeInput: true, typedSignatureInput: s.fromName }))} className="py-3 px-3 text-sm font-medium bg-gray-50 hover:bg-gray-100 text-gray-600 rounded-md flex flex-col items-center justify-center gap-1 border border-gray-200 hover:border-gray-300 transition-colors h-16 overflow-hidden">
                                    <span className="text-xl leading-none">‚úçÔ∏è</span><span className="text-xs">Type Name</span>
                                  </button>
                                </div>
                              )}
                            </div>
                          )}
                    </section>
                  </div>
                </div>
              ) : (
                <div className="lg:col-span-2 bg-white rounded-lg shadow-md overflow-auto" ref={mainPreviewRef} role="tabpanel" aria-labelledby="preview-tab-button">
                  <InvoicePreview state={state} isForPdf={false} />
                </div>
              )}

              <aside className="lg:sticky lg:top-24 h-fit space-y-6">
                <section className="bg-white rounded-lg shadow-md p-5" aria-labelledby="currency-settings-heading">
                  <h3 id="currency-settings-heading" className="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-3">Currency</h3>
                  <div className="relative">
                    <label htmlFor="selectedCurrency" className="sr-only">Select Currency</label>
                    <select id="selectedCurrency" name="selectedCurrency" value={state.selectedCurrency} onChange={handleInputChange} className={`${INPUT_BASE_CLASS} appearance-none pr-8`}>
                      {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.name}</option>)}
                    </select>
                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" aria-hidden="true">
                        <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                  </div>
                </section>
                <section className="bg-white rounded-lg shadow-md p-5" aria-labelledby="actions-heading">
                  <h3 id="actions-heading" className="text-sm font-semibold text-gray-700 uppercase tracking-wider mb-3">Actions</h3>
                  <div className="space-y-3">
                    <button type="button" onClick={() => setState(s => ({ ...s, activeTab: 'preview' }))} className="w-full flex items-center justify-center gap-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 bg-indigo-50 hover:bg-indigo-100 py-2.5 px-4 rounded-md transition-colors">
                      üëÅÔ∏è Preview Invoice
                    </button>
                    <button type="button" onClick={optimizedPdfGeneration} disabled={state.isGeneratingPdf} className="w-full flex items-center justify-center gap-2 text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 py-2.5 px-4 rounded-md transition-colors disabled:opacity-70 disabled:cursor-not-allowed">
                      üì• {state.isGeneratingPdf ? 'Generating...' : 'Download PDF'}
                    </button>
                  </div>
                </section>
              </aside>
            </div>
          </main>
        </div>
      );
    };

    // --- Mount React App ---
    const embedRootElement = document.getElementById('invoice-generator-embed-root');
    if (embedRootElement) {
      const root = ReactDOM.createRoot(embedRootElement);
      root.render(
        <StrictMode>
          <App />
        </StrictMode>
      );
    } else {
      console.error("Embed root element 'invoice-generator-embed-root' not found.");
    }
    // Do not add any code or curly braces after this!

  </script>
  <!-- END of your React/Babel script -->

  <!-- Begin iframe-resize script: -->
  <script>
    (function() {
      'use strict';
      
      // Performance optimizations for iframe resizing
      let resizeTimeout;
      let lastHeight = 0;
      let isResizing = false;
      
      // Remove body padding if inside an iframe (prevents double padding/extra space)
      if (window.self !== window.top) {
        document.body.style.padding = '0';
      }

      // Optimized height calculation with caching
      function getContainerHeight() {
        const container = document.getElementById('invoice-generator-embed-container');
        if (!container) return 0;
        return container.scrollHeight;
      }

      // Throttled post message function
      function postHeight() {
        if (isResizing) return;
        
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const height = getContainerHeight();
          
          // Only post message if height actually changed
          if (height !== lastHeight) {
            lastHeight = height;
            window.parent.postMessage(
              { type: 'INVOICE_IFRAME_HEIGHT', height: height },
              '*'
            );
          }
        }, 100); // Increased debounce time for better performance
      }

      // Optimized resize observer
      function setupResizeObserver() {
        const container = document.getElementById('invoice-generator-embed-container');
        if (container && window.ResizeObserver) {
          const ro = new ResizeObserver((entries) => {
            // Use requestAnimationFrame for better performance
            requestAnimationFrame(() => {
              if (!isResizing) {
                isResizing = true;
                postHeight();
                // Reset flag after a short delay
                setTimeout(() => { isResizing = false; }, 50);
              }
            });
          });
          ro.observe(container);
        }
      }

      // Optimized event listeners
      function setupEventListeners() {
        // Throttled resize handler
        let resizeThrottle;
        window.addEventListener('resize', () => {
          if (resizeThrottle) return;
          resizeThrottle = setTimeout(() => {
            postHeight();
            resizeThrottle = null;
          }, 150);
        });

        // Orientation change handler
        window.addEventListener('orientationchange', () => {
          setTimeout(postHeight, 500); // Delay to allow orientation change to complete
        });

        // Visibility change handler
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            requestAnimationFrame(postHeight);
          }
        });

        // Message handler
        window.addEventListener('message', function(event) {
          if (event.data === 'REQUEST_INVOICE_HEIGHT') {
            requestAnimationFrame(postHeight);
          }
        });
      }

      // Initialize when DOM is ready
      function init() {
        setupResizeObserver();
        setupEventListeners();
        postHeight(); // Initial height post
      }

      // Use DOMContentLoaded for better performance
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
